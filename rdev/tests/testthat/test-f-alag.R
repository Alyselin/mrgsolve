library(testthat)
library(mrgsolve)
library(dplyr)

rm(list=ls())

lim <- function(x,...) {
  x %>% dplyr::filter(...) %>% as.data.frame
}

Sys.setenv(R_TESTS="")
options("mrgsolve_mread_quiet"=TRUE)

context("Setting F_CMT")

code <- '
$PARAM F1=1, ALAG1=0, F2=1, ALAG2=0
$CMT CENT DEPOT

$MAIN
ALAG_CENT = ALAG1;
F_CENT = F1;
ALAG_DEPOT = ALAG2;
F_DEPOT = F2;
'

ev1 <- ev(amt=100, cmt=1)
ev2 <- ev(amt=100, cmt=2,time=1)

mod <- 
  mcode("YSY",code,warn=FALSE) %>% 
  carry_out(evid) %>% 
  update(end=2)

mod1 <- mod %>% ev(ev1)
mod2 <- mod %>% ev(ev2)

out10 <- mod1 %>% mrgsim(recsort=1)
out11 <- mod1 %>% param(F1 = 0.2) %>% mrgsim(recsort=1) 
out12 <- mod1 %>% param(F1 = 0.8) %>% mrgsim(recsort=1)
out13 <- mod1 %>% param(ALAG1 = 1) %>% mrgsim(recsort=1)
out14 <- mod1 %>% param(ALAG1 = 0.5) %>% mrgsim(recsort=1, add=c(0.49999,0.5))

out20 <- mod2 %>% mrgsim(recsort=1) 
out21 <- mod2 %>% param(F2 = 0.3) %>% mrgsim(recsort=1)
out22 <- mod2 %>% param(F2 = 0.1) %>% mrgsim(recsort=1)
out23 <- mod2 %>% param(ALAG2 = 0.3) %>% mrgsim(recsort=1,add=1.3)
out24 <- mod2 %>% param(ALAG2 = 2) %>% mrgsim(end=5,recsort=1)


test_that("F is set for compartment 1 and 2", {
  expect_true(lim(out10,time==2)$CENT==100)
  expect_true(lim(out11,time==2)$CENT==20)
  expect_true(lim(out12,time==2)$CENT==80)
  
  expect_true(lim(out20,time==2)$DEPOT==100)
  expect_true(lim(out21,time==2)$DEPOT==30)
  expect_true(lim(out22,time==2)$DEPOT==10)
})


contect("Set ALAG")
test_that("ALAG is set for compartment 1 and 2", {
  
  expect_true(lim(out10, CENT>0)$time[1]==0)
  expect_true(lim(out13, CENT>0)$time[1]==1)
  expect_true(lim(out14, CENT>0)$time[1]==0.5)
  
  expect_true(lim(out20, DEPOT>0)$time[1]==1)
  expect_true(lim(out23, DEPOT>0)$time[1]==1.3)
  expect_true(lim(out24, DEPOT>0)$time[1]==3)
})



test_that("F is set for multiple doses", {
  out1 <- 
    mod1 %>% ev(amt=100, cmt=1, addl=3, ii=1) %>% 
    param(F1 = 1) %>% 
    mrgsim(end=3,recsort=2)
  
  out2 <- 
    mod1 %>% ev(amt=100, cmt=1, addl=3, ii=1) %>% 
    param(F1 = 0.2) %>% 
    mrgsim(end=3,recsort=2)
  
  expect_equivalent(lim(out1, time > 0)$CENT, c(100,200,300))
  expect_equivalent(lim(out2, time > 0)$CENT, c(20,40,60))
})



test_that("F and ALAG are set from idata", {
  idata <- mrgsolve:::expand.idata(ID=1:3, F1=c(0.2, 0.5), ALAG1=c(0.2, 0.5,0.7,0.99))
  out1 <- mod1 %>% ev(amt=100, cmt=1, time=1) %>% idata_set(idata) %>% mrgsim()
  out2 <- mod1 %>% ev(amt=100, cmt=1, time=1) %>% idata_set(idata) %>% mrgsim(add=1+idata$ALAG1,recsort=1)
  out2 <- out2 %>% lim(CENT > 0) %>% as.tbl %>% group_by(ID)%>% slice(1)
  
  expect_equivalent(lim(out1, time==2)$CENT, 100*idata$F1)
  expect_equivalent(out2$time, 1+idata$ALAG1)
})

set.seed(101)
data(exTheoph)
df <- exTheoph

df$FORM <- as.integer(df$ID >5)
df$F1 <- mrgsolve:::mapvalues(df$FORM, c(0,1), c(0.8, 0.3))
df <- df %>% group_by(ID) %>% dplyr::mutate(ALAG1 = round(runif(1,1,3),3))
doses <- dplyr::filter(df, evid==1)


test_that("F  is set from data", {
  out1 <- mod1 %>% data_set(df) %>% mrgsim() 
  expect_equivalent(lim(out1, !duplicated(ID, fromLast=TRUE))$CENT, doses$amt*doses$F1)
})


out2 <- 
  mod1 %>% 
  data_set(df) %>% 
  mrgsim(recsort=1,add=c(doses$ALAG1),obsaug=TRUE) 

out2 <- 
  out2 %>% 
  dplyr::filter(CENT > 0) %>% 
  dplyr::group_by(ID) %>% 
  dplyr::slice(1) %>% dplyr::ungroup(.)

test_that("ALAG is set from data", {
  expect_equivalent(out2$time, doses$ALAG1)

})

